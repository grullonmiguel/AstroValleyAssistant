<UserControl x:Class="AstroValleyAssistant.Views.Dialogs.ImportView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:AstroValleyAssistant.Themes.Controls"
             xmlns:converter="clr-namespace:AstroValleyAssistant.Core.Converters">
    
    <UserControl.Resources>
        <converter:DragPromptConverter x:Key="DragPromptConverter"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Buttons -->
            <RowDefinition Height="Auto"/> <!-- Error panel -->
            <RowDefinition Height="*"/>    <!-- Preview grid -->
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Text="Import Excel / CSV" FontSize="20" FontWeight="Bold" Margin="0 0 0 10"/>

        <!-- Buttons -->
        <Border Grid.Row="1" Background="{StaticResource Brush.Accent}" Padding="16 0" Height="50">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition />
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Status -->
                <TextBlock Text="{Binding Status}" Foreground="{StaticResource Brush.Text.Subtle}" VerticalAlignment="Center"/>

                <!-- Progress -->
                <ProgressBar Grid.Column="1"
                             Height="6" Width="80"                             
                             IsIndeterminate="True"
                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <!-- Clear Button -->
                    <local:IconTextButton Text="Clear" Icon="{StaticResource Icon.Delete}" Command="{Binding ClearCommand}" Margin="0 0 8 0"  />

                    <!-- Load button -->
                    <local:IconTextButton Text="Save" Icon="{StaticResource Icon.Save}" Command="{Binding LoadIntoGridCommand}" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Error panel -->
        <Border Grid.Row="2"
                Padding="12"
                Background="{StaticResource Brush.Accent.Tertiary}"
                Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="⚠" FontSize="18" VerticalAlignment="Center" Foreground="{StaticResource Brush.Text.Subtle}"/>
                <TextBlock Text="{Binding ErrorMessage}" VerticalAlignment="Center" TextWrapping="Wrap"/>
            </StackPanel>
        </Border>

        <!-- Preview grid -->
        <DataGrid x:Name="PreviewGrid" Grid.Row="3"
                  ItemsSource="{Binding PreviewRows}"
                  HorizontalScrollBarVisibility="Visible">
        </DataGrid>

        <!-- Drag prompt overlay -->
        <Grid Grid.Row="3"
              Margin="24"
              AllowDrop="True"
              DragEnter="OnDragEnter"
              DragLeave="OnDragLeave"
              Drop="OnDrop"
              Visibility="{Binding IsEmpty, Converter={StaticResource BooleanToVisibilityConverter}}">

            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <TextBlock Text="Upload file" FontSize="24" Foreground="{DynamicResource Brush.Accent}" />
            
            <!-- Drop zone overlay -->
            <Rectangle Grid.Row="1"
                       Margin="0 16 0 8"
                       RadiusX="8"
                       RadiusY="8"
                       StrokeThickness="2">
                <Rectangle.Style>
                    <Style TargetType="Rectangle">
                        <!-- Default appearance -->
                        <Setter Property="Stroke" Value="{StaticResource Brush.Accent}"/>
                        <Setter Property="Fill"   Value="Transparent"/>

                        <!-- Dashed border -->
                        <Setter Property="StrokeDashArray">
                            <Setter.Value>
                                <DoubleCollection>4,2</DoubleCollection>
                            </Setter.Value>
                        </Setter>

                        <!-- Trigger when dragging -->
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsDragOver}" Value="True">
                                <Setter Property="Fill"   Value="{StaticResource Brush.Accent.Secondary}"/>
                                <Setter Property="Stroke" Value="{StaticResource Brush.Accent.Tertiary}"/>
                                <Setter Property="StrokeDashArray" Value="6,3"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Rectangle.Style>
            </Rectangle>

            <StackPanel Grid.Row="1" Margin="0 16 0 8" HorizontalAlignment="Center" VerticalAlignment="Center" >
                <Viewbox Width="100" Margin="0 0 0 16">
                    <Canvas Width="24" Height="24">
                        <Path Data="{StaticResource Icon.TrayDown}" Fill="{StaticResource Brush.Accent}"/>
                    </Canvas>
                </Viewbox>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{Binding IsDragOver, Converter={StaticResource DragPromptConverter}}" FontSize="16" />
                    <local:IconTextButton Text="BROWSE" 
                                            FontSize="16"
                                            Margin="4 -5 0 0"
                                            FontWeight="Bold"
                                            Command="{Binding BrowseCommand}" 
                                            Foreground="{StaticResource Brush.Accent}" 
                                            VerticalAlignment="Center" 
                                          Visibility="{Binding IsDragOver, Converter={StaticResource BooleanToVisibilityConverter},ConverterParameter=Invert}"/>
                </StackPanel>
            </StackPanel>

            <TextBlock Grid.Row="2"  Text="Supported formats: XLSX, CSV" FontSize="16" />
        </Grid>

    </Grid>

</UserControl>